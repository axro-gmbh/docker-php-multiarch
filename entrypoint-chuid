#!/bin/sh
# Change UID/GID to match env-provided values and optionally exec docker-php-entrypoint
# If called with --setup-only, perform remap and exit without exec'ing.

set -e
USERNAME="www-data"
GROUPNAME=${USERNAME}

# Change uid/gid of the user if requested via env
if [ -n "${UID:-}" ] && [ "$(id -u ${USERNAME})" != "${UID}" ]; then
    usermod -u ${UID} ${USERNAME}
fi
if [ -n "${GID:-}" ] && [ "$(id -g ${GROUPNAME})" != "${GID}" ]; then
    groupmod -g ${GID} ${GROUPNAME}
fi

# Setup-only mode for other entrypoints (e.g., cron) that need remap without exec
if [ "${1:-}" = "--setup-only" ]; then
    exit 0
fi

# Call parent entrypoint (as other user) when needed
if [ -n "${USERSPACE:-}" ]; then
    # Downgrade to ${USERNAME}
    su-exec ${USERNAME} docker-php-entrypoint "$@"
else
    # Run as same user (root)
    exec docker-php-entrypoint "$@"
fi
